---
title: "Explore topics in German migration coverage"
author: "Nicolai Berk"
date: "16 9 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)

library(tidyverse)
library(data.table)
library(here)
library(stm)
library(lubridate)
library(tidytext)
library(ggthemes)
library(scales)
library(knitr)
library(dplyr)
```

This document describes the topics in a 60-topic structural topic model (cite) of German news coverage of the migration issue in 2015-2019. It contains a plot showing the relative frequencies of topics, a table with most important words according to different statistics and a list of the ten most representative documents for each topic.

## Figure

```{r plot, fig.height=15}

# explore following Julia Silge's blogpost: https://juliasilge.com/blog/evaluating-stm/
load(here('data/topic_model_K60.Rdata'))
load(here('data/out_docs.Rdata'))

td_beta <- tidy(topic_model)
td_gamma <- tidy(topic_model, matrix = "gamma",
                 document_names = rownames(out$documents))


top_terms <- td_beta %>%
  arrange(beta) %>%
  group_by(topic) %>%
  top_n(7, beta) %>%
  arrange(-beta) %>%
  select(topic, term) %>%
  summarise(terms = list(term)) %>%
  mutate(terms = map(terms, paste, collapse = ", ")) %>%
  unnest(cols = c(terms))

gamma_terms <- td_gamma %>%
  group_by(topic) %>%
  summarise(gamma = mean(gamma)) %>%
  arrange(desc(gamma)) %>%
  left_join(top_terms, by = "topic") %>%
  mutate(topic = paste0("Topic ", topic),
         topic = reorder(topic, gamma))

gamma_terms %>%
  top_n(60, gamma) %>%
  ggplot(aes(topic, gamma, label = terms, fill = topic)) +
  geom_col(show.legend = FALSE) +
  geom_text(hjust = 0, nudge_y = 0.0005, size = 3) +
  coord_flip() +
  scale_y_continuous(expand = c(0,0),
                     limits = c(0, 0.09),
                     labels = percent_format()) +
  theme_tufte(ticks = FALSE) +
  theme(plot.title = element_text(size = 16),
        plot.subtitle = element_text(size = 13)) +
  labs(x = NULL, y = expression(gamma),
       title = "Migration topics by prevalence",
       subtitle = "With the top words that contribute to each topic")
```

## most representative words per topic

```{r wordlist}

sageLabels(topic_model)

```

## most representative articles per topic

```{r}
## associated documents of selected topics
for (i in 1:60){
  cat(paste(
    '\n\n------------------------------------------------------------\n\n',
    '5 most representative documents for topic ', i,
    '\n\n------------------------------------------------------------\n\n'))
  print(findThoughts(topic_model, texts = out$meta$text, n = 5, topics = i, )$docs[[1]])
  cat(paste('\n\n------------------------------------------------------------\n\n'))
}

```



<!-- ## look into selected topic prevalence across time & newspapers -->

<!-- ### crime 1: police & refugees -->
<!-- crime <- topic_model$theta[,25] -->
<!-- ggplot(mapping = aes(x=out$meta$date_new, y = crime))+ -->
<!--   geom_smooth() -->
<!-- ggplot(mapping = aes(x=out$meta$paper, y = log(crime)))+ -->
<!--   geom_boxplot() -->

<!-- ### mediterranean route & drowning of refugees -->
<!-- medit <- topic_model$theta[,49]  -->
<!-- ggplot(mapping = aes(x=out$meta$date_new, y = medit))+ -->
<!--   geom_smooth() -->

<!-- ### number of asylum seekers arriving -->
<!-- refnums <- topic_model$theta[,32]  -->
<!-- ggplot(mapping = aes(x=out$meta$date_new, y = refnums))+ -->
<!--   geom_smooth() -->

<!-- ### deportation (Afghanistan) -->
<!-- deport <- topic_model$theta[,44]  -->
<!-- ggplot(mapping = aes(x=out$meta$date_new, y = deport))+ -->
<!--   geom_smooth() -->

<!-- ### local refugee accommodation -->
<!-- accomm <- topic_model$theta[,58]  -->
<!-- ggplot(mapping = aes(x=out$meta$date_new, y = accomm))+ -->
<!--   geom_smooth() -->

<!-- ### greek internment camps -->
<!-- camps <- topic_model$theta[,27]  -->
<!-- ggplot(mapping = aes(x=out$meta$date_new, y = camps))+ -->
<!--   geom_smooth() -->

<!-- ### labour market integration -->
<!-- labmar <- topic_model$theta[,11]  -->
<!-- ggplot(mapping = aes(x=out$meta$date_new, y = labmar))+ -->
<!--   geom_smooth() -->

<!-- ### crime 2: capital crimes (rape, murder, cologne) -->
<!-- capcrime <- topic_model$theta[,48]  -->
<!-- ggplot(mapping = aes(x=out$meta$date_new, y = capcrime))+ -->
<!--   geom_smooth() -->
<!-- ggplot(mapping = aes(x=out$meta$paper, fill = out$meta$paper, y = log(capcrime)))+ -->
<!--   geom_violin() -->

<!-- ggplot(mapping = aes(x=out$meta$date_new, y = capcrime+crime))+ -->
<!--   geom_smooth() -->
<!-- ggplot(mapping = aes(x=out$meta$paper, fill = out$meta$paper, y = log(capcrime+crime)))+ -->
<!--   geom_violin() -->


<!-- ### generate output file with daily prevalence -->
<!-- prevalence <-  -->
<!--   data.frame( -->
<!--     crime, medit, deport, refnums, camps, labmar, capcrime -->
<!--   ) %>%  -->
<!--   cbind(paper = out$meta$paper) %>%  -->
<!--   cbind(date_new = out$meta$date_new) %>%  -->
<!--   group_by(paper, date_new) %>%  -->
<!--   summarise( -->
<!--     crime_m    = mean(crime), -->
<!--     medit_m    = mean(medit), -->
<!--     deport_m   = mean(deport), -->
<!--     refnums_m  = mean(refnums), -->
<!--     camps_m    = mean(camps), -->
<!--     labmar_m   = mean(labmar), -->
<!--     capcrime_m = mean(capcrime), -->
<!--     crime_s    = sum(crime), -->
<!--     medit_s    = sum(medit), -->
<!--     deport_s   = sum(deport), -->
<!--     refnums_s  = sum(refnums), -->
<!--     camps_s    = sum(camps), -->
<!--     labmar_s   = sum(labmar), -->
<!--     capcrime_s = sum(capcrime), -->
<!--     crime_sd   = sd(crime), -->
<!--     medit_sd   = sd(medit), -->
<!--     deport_sd  = sd(deport), -->
<!--     refnums_sd = sd(refnums), -->
<!--     camps_sd   = sd(camps), -->
<!--     labmar_sd  = sd(labmar), -->
<!--     capcrime_sd = sd(capcrime) -->
<!--     ) -->

<!-- save(prevalence, file = here('data/daily_mig_topics.Rdata')) -->

<!-- # save meta with topic attention -->
<!-- topic_attention <-  -->
<!--   data.frame( -->
<!--     crime, medit, deport, refnums, camps, labmar, capcrime -->
<!--     ) -->

<!-- output <- cbind(out$meta, topic_attention) -->
<!-- save(output, file = here('data/mig_articles_topics.Rdata')) -->
